<script>
  const symbols = [
    'symbol_1.png','symbol_2.png','symbol_3.png','symbol_4.png',
    'symbol_5.png','symbol_6.png','symbol_7.png','symbol_8.png'
  ];
  const symbolValues = {
    'symbol_1.png':1,'symbol_2.png':4,'symbol_3.png':6,
    'symbol_4.png':10,'symbol_5.png':0.80,'symbol_6.png':1.20,
    'symbol_7.png':1,'symbol_8.png':5
  };
  const multipliers = [1,2,3,'wheel'];

  let balance = 100;
  let autoSpin = false;
  let spinInterval = null;
  let spinSpeed = 100; // Normal

  function updateBalance(highlight) {
    const balanceEl = document.getElementById('balance');
    balanceEl.textContent = `Saldo: $${balance}`;
    if (highlight) {
      balanceEl.style.color = '#0f0';
      setTimeout(() => balanceEl.style.color = '#fff', 1000);
    }
  }

  function showFloatingWin(msg) {
    const floating = document.getElementById('floatingWin');
    setTimeout(() => {
      floating.textContent = msg;
      floating.classList.add('show');
      setTimeout(() => floating.classList.remove('show'), 4000);
    }, 500);
  }

  function getSymbolName(src) {
    return symbols.find(s => src.includes(s));
  }

  function spin() {
    const bet = parseInt(document.getElementById('betAmount').value);
    if (balance < bet) {
      alert('Saldo insuficiente');
      stopAuto();
      return;
    }
    balance -= bet; updateBalance();

    document.getElementById('spinSound').play();
    const cols = [0,1,2].map(i => document.querySelectorAll(`#col-${i} img`));
    const multCol = document.querySelectorAll('#col-mult img');
    const resultText = document.getElementById('result');
    document.querySelectorAll('img').forEach(img => img.classList.remove('winner'));
    resultText.textContent = 'Girando...';

    let interval = setInterval(() => {
      cols.forEach(col => {
        const top = symbols[Math.floor(Math.random()*symbols.length)];
        col[2].src = col[1].src; col[1].src = col[0].src; col[0].src = top;
      });
      multCol.forEach(img => {
        const val = multipliers[Math.floor(Math.random()*multipliers.length)];
        img.dataset.value = val;
        img.src = val==='wheel' ? 'mult_wheel.png' : `mult_${val}.png`;
      });
    }, spinSpeed);

    setTimeout(() => {
      clearInterval(interval);
      const grid = cols.map(col => Array.from(col).map(img => getSymbolName(img.src)));
      const multiplier = multCol[1].dataset.value;

      const allWins = [];
      function isWinningLine(s1, s2, s3) {
        const line = [s1, s2, s3];
        const nonWild = line.filter(s => s !== 'symbol_8.png');
        const wilds = line.filter(s => s === 'symbol_8.png').length;
        if (nonWild.length === 0 && wilds === 3) return 'symbol_8.png';
        if (nonWild.length === 3 && new Set(nonWild).size === 1) return nonWild[0];
        if (nonWild.length === 1 && wilds === 2) return nonWild[0];
        if (nonWild.length === 2 && new Set(nonWild).size === 1 && wilds === 1) return nonWild[0];
        return false;
      }

      for (let row = 0; row < 3; row++) {
        const result = isWinningLine(grid[0][row], grid[1][row], grid[2][row]);
        if (result) {
          allWins.push({
            symbol: result,
            cells: [cols[0][row], cols[1][row], cols[2][row]]
          });
        }
      }

      let diag1 = isWinningLine(grid[0][0], grid[1][1], grid[2][2]);
      if (diag1) allWins.push({
        symbol: diag1,
        cells: [cols[0][0], cols[1][1], cols[2][2]]
      });

      let diag2 = isWinningLine(grid[0][2], grid[1][1], grid[2][0]);
      if (diag2) allWins.push({
        symbol: diag2,
        cells: [cols[0][2], cols[1][1], cols[2][0]]
      });

      if (allWins.length) {
        allWins.forEach(win => win.cells.forEach(img => img.classList.add('winner')));
        multCol[1].classList.add('winner');
        document.getElementById('winSound').play();
      }

      if (multiplier === 'wheel') {
        multCol[1].classList.add('winner');
        setTimeout(() => {
          openWheelModal(resultText, allWins.reduce((sum,w)=>sum+symbolValues[w.symbol]*bet,0));
        }, 2000);
      } else {
        const multNum = parseInt(multiplier)||1;
        if (allWins.length) {
          const base = allWins.reduce((sum,w)=>sum+symbolValues[w.symbol]*bet,0);
          const prize = base * multNum;
          balance += prize;
          updateBalance(true);
          resultText.textContent = `üéâ Ganaste: $${base} x${multNum} = $${prize}`;
          showFloatingWin(`+$${prize}`);
        } else resultText.textContent = 'Intenta de nuevo';
      }

    }, 2000);
  }

  function openWheelModal(resultText, basePrize) {
    document.getElementById('wheelSound').play();
    const modal = document.getElementById('wheelModal');
    const wheelStatus = document.getElementById('wheelStatus');
    const wheelResult = document.getElementById('wheelResult');
    const wheelImage = document.getElementById('wheelImage');
    const bonusOptions = [5,10,1000000];
    const degreesPerSlice = 360 / bonusOptions.length;

    modal.style.display = 'flex';
    wheelStatus.textContent = 'üé° Preparando ruleta...';
    wheelResult.textContent = '';

    setTimeout(() => {
      const prizeIndex = Math.floor(Math.random() * bonusOptions.length);
      const prize = bonusOptions[prizeIndex];
      const extraSpins = 5;
      const angle = 360 * extraSpins + (prizeIndex * degreesPerSlice) + degreesPerSlice/2;
      wheelImage.style.transform = `rotate(${angle}deg)`;

      setTimeout(() => {
        wheelStatus.textContent = 'üéâ Resultado:';
        wheelResult.textContent = `$${prize}`;

        if (prize >= 1000000) {
          balance = 0; updateBalance();
          document.getElementById('explosionSound').play();
          document.body.classList.add('shake');
          setTimeout(() => {
            document.getElementById('destroyScreen').style.display = 'flex';
          }, 1000);
        } else {
          const total = basePrize + prize;
          balance += total;
          updateBalance(true);
          resultText.textContent = `üé° Wheel Bonus: Base $${basePrize} + Ruleta $${prize} = Total $${total}`;
          showFloatingWin(`+$${total}`);
          setTimeout(() => modal.style.display = 'none', 2000);
        }
      }, 5000);
    }, 2000);
  }

  function toggleAuto() {
    if (autoSpin) {
      stopAuto();
    } else {
      autoSpin = true;
      document.getElementById('autoBtn').textContent = '‚èπÔ∏è Stop';
      spin();
      spinInterval = setInterval(spin, 3000);
    }
  }

  function stopAuto() {
    autoSpin = false;
    clearInterval(spinInterval);
    document.getElementById('autoBtn').textContent = '‚ñ∂Ô∏è Auto';
  }

  function setSpeed(mult) {
    spinSpeed = 100 / mult;
    document.getElementById('speedStatus').textContent = `Velocidad: x${mult}`;
  }
</script>
